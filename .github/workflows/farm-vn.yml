name: Farm Rewards VN

concurrency:
  group: farm-rewards-vn
  cancel-in-progress: false

on:
  schedule:
    # Run 3 times/day: 
    # 08:00 VN = 01:00 UTC
    # 14:00 VN = 07:00 UTC
    # 19:00 VN = 12:00 UTC
    - cron: '0 1,7,12 * * *'
  workflow_dispatch:
    inputs:
      account_filter:
        description: 'Select account to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - minhtuan.dev88@outlook.com
          - quanghuy.netvn@outlook.com
      skip_delay:
        description: 'Skip random start delay'
        required: false
        default: false
        type: boolean

jobs:
  farm:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Random Startup Delay (0-5 minutes)
      if: ${{ github.event.inputs.skip_delay != 'true' }}
      run: |
        DELAY=$((RANDOM % 300))
        echo "Waiting $DELAY seconds before starting..."
        sleep $DELAY

    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'

    - name: Install Dependencies
      run: npm ci

    - name: Install Patchright Browser
      run: npx patchright install chromium

    - name: Install Xvfb & Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb libnss3 libatk-bridge2.0-0 libdrm2 libxkbcommon0 libgbm1 libasound2t64

    - name: Setup Config
      run: |
        if [ -n "${{ secrets.CONFIG_JSON }}" ]; then
          echo '${{ secrets.CONFIG_JSON }}' > src/config.jsonc
        elif [ ! -f "src/config.jsonc" ]; then
          cp src/config.example.jsonc src/config.jsonc
        fi

    - name: Setup Accounts
      run: |
        if [ -n "${{ secrets.ACCOUNTS_JSON }}" ]; then
          echo '${{ secrets.ACCOUNTS_JSON }}' > src/accounts.jsonc
        elif [ ! -f "src/accounts.jsonc" ]; then
          cp src/accounts.example.jsonc src/accounts.jsonc
        fi

    - name: Filter & Shuffle Accounts
      env:
        ACCOUNT_FILTER: ${{ github.event.inputs.account_filter }}
      run: |
        node -e '
          const fs = require("fs");
          try {
            const content = fs.readFileSync("src/accounts.jsonc", "utf8");
            let accounts = JSON.parse(content);
            
            // Filter by email if specified (not "all")
            const filter = process.env.ACCOUNT_FILTER;
            if (filter && filter !== "all") {
              const originalCount = accounts.length;
              accounts = accounts.filter(acc => 
                acc.email.toLowerCase() === filter.toLowerCase()
              );
              console.log(`Filtered: ${accounts.length}/${originalCount} - Running only "${filter}"`);
              if (accounts.length === 0) {
                throw new Error(`No accounts match: ${filter}`);
              }
            }
            
            // Shuffle
            for (let i = accounts.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [accounts[i], accounts[j]] = [accounts[j], accounts[i]];
            }
            
            fs.writeFileSync("src/accounts.jsonc", JSON.stringify(accounts, null, 2));
            console.log("Running", accounts.length, "account(s):", accounts.map(a => a.email).join(", "));
          } catch (e) {
            console.error("Error:", e.message);
            process.exit(1);
          }
        '

    - name: Build TypeScript
      run: npm run build

    - name: Restore Session Cache
      uses: actions/cache@v4
      with:
        path: sessions
        key: sessions-vn-${{ github.ref }}-${{ github.run_id }}
        restore-keys: |
          sessions-vn-${{ github.ref }}-
          sessions-vn-

    - name: Start Bot with Xvfb
      env:
        TZ: 'Asia/Ho_Chi_Minh'
        FORCE_HEADLESS: '0'
        ACCOUNT_DELAY_MIN: '60000'
        ACCOUNT_DELAY_MAX: '180000'
        # Disable bot's internal scheduler - use GitHub Actions cron instead
        REWARDS_SCHEDULING_ENABLED: 'false'
        # Disable dashboard to ensure clean exit
        REWARDS_DASHBOARD_ENABLED: 'false'
      run: |
        xvfb-run --auto-servernum --server-args="-screen 0 1920x1080x24" npm start

    - name: Save Session Cache
      if: always()
      uses: actions/cache/save@v4
      with:
        path: sessions
        key: sessions-vn-${{ github.ref }}-${{ github.run_id }}

    - name: Upload Session Backup
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: sessions-backup-vn-${{ github.run_id }}
        path: sessions/
        retention-days: 7

    - name: Upload Error Screenshots
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: error-screenshots-vn-${{ github.run_id }}
        path: |
          browser/screenshots/
          *.png
        retention-days: 3
